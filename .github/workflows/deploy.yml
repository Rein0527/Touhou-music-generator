name: Build & Deploy Touhou Player

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # â† è‹¥æƒ³æŠŠ JSON å›å¯«åˆ° repoï¼Œéœ€è¦ writeï¼›åªæ˜¯éƒ¨ç½²ä¹Ÿå¯ä¿ç•™
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Env info (Node/Bash)
        run: |
          node -v
          bash --version
          echo "Workspace:"; ls -la

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify project layout
        run: |
          echo "Root listing:"; ls -la
          echo "music/ listing:"; ls -la music || echo "(no music dir)"
          echo "data/ listing:"; ls -la data || echo "(no data dir yet)"

      - name: Generate data/tracks.json & images.json
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data scripts
          # èªªæ˜æª”ï¼ˆè‡ªå‹•å»ºç«‹/è¦†è“‹ï¼‰
          cat > data/README.md << 'MD'
          # Data è³‡æ–™å¤¾èªªæ˜
          æ­¤è³‡æ–™å¤¾çš„æª”æ¡ˆç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿï¼Œè«‹å‹¿æ‰‹å‹•ç·¨è¼¯ã€‚
          - `tracks.json`ï¼šç”± `/music/**` è‡ªå‹•æƒæéŸ³æª”ç”Ÿæˆã€‚
          - `images.json`ï¼šä¾ `tracks.json` çš„ tags å¾ Danbooru æ“·å– rating:safe åœ–ç‰‡ç”Ÿæˆã€‚
          æ–°å¢æ­Œæ›²ï¼šæŠŠæª”æ¡ˆæ”¾åˆ° `/music/` æˆ–å­è³‡æ–™å¤¾ä¸¦ pushï¼ŒActions æœƒè‡ªå‹•é‡å»ºé€™äº›æª”æ¡ˆã€‚
          MD

          # ç”Ÿæˆè…³æœ¬
          cat > scripts/gen.mjs << 'EOF'
          import fs from 'node:fs';
          import path from 'node:path';

          const musicRoot = path.join(process.cwd(),'music');
          const dataDir   = path.join(process.cwd(),'data');
          const exts = new Set(['.mp3','.ogg','.wav','.m4a','.flac']);

          function walk(dir){
            let out = [];
            if (!fs.existsSync(dir)) return out;
            for (const name of fs.readdirSync(dir)){
              if (name.startsWith('.')) continue;
              const p = path.join(dir, name);
              const st = fs.statSync(p);
              if (st.isDirectory()) out = out.concat(walk(p));
              else if (exts.has(path.extname(name).toLowerCase())) out.push(p);
            }
            return out;
          }

          // ---- tracks.json ----
          let relFiles = [];
          if (fs.existsSync(musicRoot)) {
            relFiles = walk(musicRoot).map(abs =>
              path.posix.join('music', path.relative(musicRoot, abs).split(path.sep).join('/'))
            );
          } else {
            console.log('âš ï¸  æ²’æœ‰ /music ç›®éŒ„ï¼Œtracks.json å°‡ç‚ºç©ºé™£åˆ—');
          }

          function sanitizeTag(s){ return s.toLowerCase().replace(/[^a-z0-9_\-]/g,'').slice(0,40); }

          const tracks = relFiles.map(rel => {
            const base = path.basename(rel).replace(/\.[^.]+$/,'');
            let artist='Unknown', title=base;
            const m = base.split(' - ');
            if (m.length>=2){ artist=m[0]; title=m.slice(1).join(' - '); }
            // è·¯å¾‘ â†’ tagsï¼ˆè³‡æ–™å¤¾å + æª”åé—œéµè©ï¼‰+ é è¨­ touhou
            const segs = rel.split('/').slice(1,-1);
            const dirTags = segs.map(sanitizeTag).filter(Boolean);
            const nameTags = base.split(/[^a-zA-Z0-9]+/).map(sanitizeTag).filter(Boolean);
            const set = new Set(['touhou', ...dirTags, ...nameTags]);
            return { file: rel, title, artist, tags: [...set].slice(0,8) };
          });

          fs.writeFileSync(path.join(dataDir,'tracks.json'), JSON.stringify(tracks, null, 2));
          console.log('âœ… tracks.json ç”¢ç”Ÿå®Œæˆï¼Œæ›²ç›®æ•¸ï¼š', tracks.length);

          // ---- images.json ----
          const tagSet = new Set(['touhou']);
          tracks.forEach(t => (t.tags||['touhou']).forEach(tag => tagSet.add(tag)));

          const images = {};
          for (const tag of tagSet) {
            try {
              const url = `https://danbooru.donmai.us/posts.json?limit=30&tags=${encodeURIComponent(tag + ' rating:safe order:rank')}`;
              const res = await fetch(url, { headers: { 'User-Agent': 'GitHubActions/1.0 (+pages)' }});
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const arr = await res.json();
              const seen = new Set(); const list = [];
              for (const p of arr) {
                const u = p.large_file_url || p.file_url;
                if (!u || p.rating !== 's') continue;
                const abs = u.startsWith('http') ? u : `https://danbooru.donmai.us${u}`;
                if (seen.has(abs)) continue;
                seen.add(abs);
                list.push({ url: abs, source: `post:${p.id}` });
              }
              images[tag] = list;
              console.log(`ğŸ–¼ï¸  ${tag}: ${list.length} å¼µ`);
              await new Promise(r => setTimeout(r, 250));
            } catch (err) {
              console.log('âš ï¸  ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—ï¼š', tag, err.message);
              images[tag] = images[tag] || [];
            }
          }
          fs.writeFileSync(path.join(dataDir,'images.json'), JSON.stringify(images, null, 2));
          console.log('âœ… images.json ç”¢ç”Ÿå®Œæˆ');
          EOF

          node scripts/gen.mjs

      - name: Sanity check artifacts
        run: |
          echo "--- data dir (workspace) ---"; ls -la data || true
          echo "--- tracks head ---"; (head -n 20 data/tracks.json || true)
          echo "--- images head ---"; (head -n 20 data/images.json || true)

      # ï¼ˆå¯é¸ï¼‰æŠŠç”¢ç”Ÿçš„ JSON å›å¯«åˆ° repoï¼Œè®“ä½ åœ¨ GitHub æª”æ¡ˆæ¨¹ä¹Ÿçœ‹å¾—åˆ°
      - name: Commit generated JSON back to repo (optional)
        if: ${{ success() }}
        run: |
          set -e
          if [ -n "$(git status --porcelain data)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/*.json data/README.md
            git commit -m "chore(data): auto-generate tracks/images"
            git push || echo "(no changes pushed)"
          else
            echo "No changes in data/ to commit."
          fi

      - name: Prepare artifact (copy everything to dist via tar)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          tar -cf - \
            --exclude='./.git' \
            --exclude='./dist' \
            . | (cd dist && tar -xf -)
          echo "Dist listing:"; ls -la dist
          echo "Dist/data:"; ls -la dist/data || true
          echo "Dist/music:"; ls -la dist/music || true

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
