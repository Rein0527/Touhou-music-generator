<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Touhou Player — M1+M2 MVP (Rev D)</title>
  <style>
    :root {
      --bg-fade-ms: 850;
      --text: #edeef2; --muted: #9aa3b2;
      --panel: rgba(16,18,24,0.55); --border: rgba(148,163,184,0.16);
    }
    html, body { height: 100%; margin: 0; background:#0b0d12; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "PingFang TC", "Microsoft JhengHei", Arial; }
    .app { position: relative; min-height: 100%; overflow: hidden; }
    .bg, .bg-next { position:absolute; inset:0; background-position:center; background-size:cover; filter: blur(8px) saturate(1.05) brightness(0.74); transform: scale(1.03); transition: opacity calc(var(--bg-fade-ms) * 1ms) ease; }
    .bg { opacity:1; } .bg-next { opacity:0; }
    .bg-dim { position:absolute; inset:0; background: radial-gradient(ellipse at center, rgba(0,0,0,0.2), rgba(0,0,0,0.62) 58%, rgba(0,0,0,0.82)); pointer-events:none; }
    .stage { position:relative; z-index:10; display:grid; place-items:center; min-height:72vh; padding-top:5vh; }
    canvas { width:min(78vmin,1040px); height:min(78vmin,1040px); aspect-ratio:1/1; touch-action:none; }
    .bar { position:fixed; left:0; right:0; bottom:0; z-index:20; display:grid; grid-template-columns:auto 1fr auto auto; gap:14px; align-items:center; padding:12px clamp(14px,3vw,24px); backdrop-filter: blur(8px); background:var(--panel); border-top:1px solid var(--border); }
    .meta { min-width:200px; overflow:hidden; }
    .title { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .artist { color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .controls { display:inline-flex; gap:10px; }
    .btn { appearance:none; border:1px solid rgba(148,163,184,0.22); color:var(--text); background:linear-gradient(180deg, rgba(33,41,54,.65), rgba(18,23,33,.65)); padding:10px 12px; border-radius:12px; font-size:14px; cursor:pointer; user-select:none; }
    .btn.icon{ width:44px; height:44px; display:grid; place-items:center; font-size:18px;}
    .vol{ display:inline-flex; align-items:center; gap:8px; font-size:12px; color:var(--muted);} .vol input{ width:140px;}
    .filepick{ font-size:12px; opacity:.85;}
    .dropmask{ position:fixed; inset:0; background:rgba(18,23,33,0.75); color:var(--text); display:none; place-items:center; z-index:40; border:2px dashed rgba(255,255,255,0.35); font-size:clamp(16px,3vw,24px); letter-spacing:1px;}
    .dropmask.on{ display:grid;}
    .hint{ position:fixed; top:16px; left:50%; transform:translateX(-50%); font-size:12px; color:var(--muted); opacity:.88; z-index:20; background:var(--panel); border:1px solid var(--border); padding:6px 10px; border-radius:999px;}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="bg" id="bg"></div>
    <div class="bg-next" id="bgNext"></div>
    <div class="bg-dim"></div>

    <div class="hint">Space 播放/暫停 · A/D 上/下一首 · ←/→ 跳 5 秒（Ctrl=15 秒） · 舞台「水平」點擊/拖曳快轉 · 拖放音檔加入播放</div>

    <div class="stage" id="stage">
      <canvas id="viz" width="1200" height="1200" aria-label="視覺化畫布" role="img"></canvas>
    </div>

    <div class="bar" role="group" aria-label="播放器控制">
      <div class="controls">
        <button class="btn icon" id="prev" title="上一首">⟨</button>
        <button class="btn icon" id="play" title="播放/暫停">▶</button>
        <button class="btn icon" id="next" title="下一首">⟩</button>
      </div>
      <div class="meta">
        <div class="title" id="metaTitle">—</div>
        <div class="artist" id="metaArtist">—</div>
      </div>
      <label class="btn filepick" for="fileInput">＋ 匯入本地音樂</label>
      <input id="fileInput" type="file" accept="audio/*" multiple hidden />
      <div class="vol">音量 <input id="volume" type="range" min="0" max="1" step="0.01" value="1" /></div>
    </div>

    <div class="dropmas
