name: Build & Deploy Touhou Player

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate data/tracks.json & images.json (with encodeURI + repo base)
        run: |
          set -euo pipefail
          mkdir -p data
          node --input-type=module - <<'NODE'
          import fs from 'node:fs';
          import path from 'node:path';
          import process from 'node:process';

          // ---- GitHub Pages base path ----
          // user/repo å– repo åï¼›å€‹äººé å€‰åº«å¦‚ user.github.io å‰‡ç•¶ä½œæ ¹ç›®éŒ„ "/"
          const repoFull = process.env.GITHUB_REPOSITORY || '';
          const repoName = (repoFull.split('/')[1] || '').trim();
          const pagesBase = repoName.endsWith('.github.io') ? '/' : `/${repoName}/`;

          const musicRoot = path.join(process.cwd(),'music');
          const dataDir   = path.join(process.cwd(),'data');
          const exts = new Set(['.mp3','.ogg','.wav','.m4a','.flac']);

          // å»æ‰å‰å°ç·¨è™Ÿï¼ˆå«ç©ºç™½/å…¨å½¢ç¬¦è™Ÿï¼‰
          const stripLeadingIndex = (s) => s.replace(/^\s*\d+\s*[.\-ï¼¿ï¼]?\s*/u,'').trim();

          function walk(dir){
            let out = [];
            if (!fs.existsSync(dir)) return out;
            for (const name of fs.readdirSync(dir)){
              if (name.startsWith('.')) continue;
              const p = path.join(dir, name);
              const st = fs.statSync(p);
              if (st.isDirectory()) out = out.concat(walk(p));
              else if (exts.has(path.extname(name).toLowerCase())) out.push(p);
            }
            return out;
          }

          // ---- tracks.json ----
          let files = [];
          if (fs.existsSync(musicRoot)) files = walk(musicRoot);

          const tracks = files.map(abs => {
            // ç›¸å°è·¯å¾‘ï¼ˆposix æ–œç·šï¼‰
            const rel = path.posix.join('music', path.relative(musicRoot, abs).split(path.sep).join('/'));

            // 1) å…ˆè£œ Pages baseï¼Œç¢ºä¿åœ¨ repo å­è·¯å¾‘ä¸Šå¯ç”¨
            const rawURL = pagesBase + rel;

            // 2) encodeURIï¼šè™•ç†ç©ºæ ¼/é ASCIIï¼ˆä¿ç•™ / : ? # ç­‰å¿…è¦ç¬¦è™Ÿï¼‰
            const encodedURL = encodeURI(rawURL);

            // 3) titleï¼šå»æ‰å‰¯æª”åèˆ‡å‰å°ç·¨è™Ÿ
            const base = stripLeadingIndex(path.basename(rel).replace(/\.[^.]+$/,''));

            return { file: encodedURL, title: base, artist: "" };
          });

          fs.writeFileSync(path.join(dataDir,'tracks.json'), JSON.stringify(tracks, null, 2));
          console.log(`âœ… tracks.json generated: ${tracks.length} tracks`);

          // ---- images.jsonï¼ˆç°¡ç‰ˆï¼šå›ºå®š 'touhou'ï¼›å¯å†æ“´å……ï¼‰----
          const images = {};
          try {
            const url = `https://danbooru.donmai.us/posts.json?limit=30&tags=${encodeURIComponent('touhou rating:safe order:rank')}`;
            const res = await fetch(url, { headers: { 'User-Agent': 'GitHubActions/1.0 (+pages)' }});
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const arr = await res.json();
            const seen = new Set(); const list = [];
            for (const p of arr) {
              const u = p.large_file_url || p.file_url;
              if (!u || p.rating !== 's') continue;
              const abs = u.startsWith('http') ? u : `https://danbooru.donmai.us${u}`;
              if (seen.has(abs)) continue;
              seen.add(abs);
              list.push({ url: abs, source: `post:${p.id}` });
            }
            images['touhou'] = list;
            console.log(`ğŸ–¼ï¸ touhou: ${list.length} images`);
          } catch (e) {
            console.log('âš ï¸ images fetch failed:', e.message);
            images['touhou'] = [];
          }
          fs.writeFileSync(path.join(dataDir,'images.json'), JSON.stringify(images, null, 2));
          console.log('âœ… images.json generated');
          NODE

      - name: Sanity check
        run: |
          echo '--- data dir ---'
          ls -la data || true
          echo '--- tracks.json head ---'
          (head -n 20 data/tracks.json || true)
          echo '--- images.json head ---'
          (head -n 20 data/images.json || true)

      - name: Prepare artifact (include data/)
        run: |
          set -euo pipefail
          mkdir -p dist
          rsync -av --delete \
            --exclude 'dist' \
            --exclude '.git' \
            --exclude '.github' \
            ./ dist/
          # ç¢ºä¿ data ä¸€å®šè¢«å¸¶é€²éƒ¨ç½²
          mkdir -p dist/data
          cp -f data/tracks.json dist/data/tracks.json
          cp -f data/images.json dist/data/images.json
          [ -f data/README.md ] && cp -f data/README.md dist/data/README.md || true

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
